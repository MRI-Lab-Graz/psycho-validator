<!-- NeuroBagel Annotation Widget -->
<div id="neurobagelAnnotationWidget">
  <style>
    .neurobagel-widget {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .nb-sidebar {
      flex: 0 0 220px;
      border-right: 1px solid #dee2e6;
      padding-right: 15px;
      max-height: 550px;
      overflow-y: auto;
    }
    
    .nb-main {
      flex: 1;
      min-height: 400px;
    }
    
    .nb-section-title {
      font-weight: 600;
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      margin: 15px 0 8px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .nb-column-item {
      padding: 8px 10px;
      margin: 4px 0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      border-left: 3px solid transparent;
      transition: all 0.2s ease;
    }
    
    .nb-column-item:hover {
      background: #e7f1ff;
      border-left-color: #0d6efd;
    }
    
    .nb-column-item.active {
      background: #0d6efd;
      color: white;
      border-left-color: #0d6efd;
      font-weight: 600;
    }
    
    .nb-column-item-type {
      font-size: 11px;
      opacity: 0.7;
      margin-left: 4px;
    }
    
    .nb-editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 12px;
      border-bottom: 2px solid #dee2e6;
    }
    
    .nb-editor-title {
      font-size: 16px;
      font-weight: 600;
    }
    
    .nb-editor-type-badge {
      background: #0d6efd;
      color: white;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .nb-field-group {
      margin-bottom: 20px;
    }
    
    .nb-field-label {
      font-weight: 600;
      font-size: 12px;
      color: #212529;
      margin-bottom: 6px;
      text-transform: uppercase;
    }
    
    .nb-field-description {
      font-size: 13px;
      color: #666;
      margin-bottom: 10px;
      padding: 8px;
      background: white;
      border-left: 3px solid #0d6efd;
      border-radius: 2px;
    }
    
    .nb-value-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .nb-value-item {
      padding: 10px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .nb-value-item:hover {
      border-color: #0d6efd;
      background: #f0f6ff;
    }
    
    .nb-value-item.selected {
      border-color: #0d6efd;
      background: #e7f1ff;
    }
    
    .nb-value-header {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 4px;
    }
    
    .nb-value-label {
      color: #666;
      font-size: 12px;
      margin-bottom: 3px;
    }
    
    .nb-value-uri {
      font-size: 11px;
      color: #999;
      font-family: monospace;
      word-break: break-all;
    }
    
    .nb-button-group {
      display: flex;
      gap: 8px;
      margin-top: 15px;
    }
    
    .nb-btn {
      padding: 8px 12px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .nb-btn:hover {
      background: #e7f1ff;
      border-color: #0d6efd;
    }
    
    .nb-btn-primary {
      background: #0d6efd;
      color: white;
      border-color: #0d6efd;
    }
    
    .nb-btn-primary:hover {
      background: #0b5ed7;
    }
    
    .nb-empty-state {
      padding: 40px 20px;
      text-align: center;
      color: #999;
    }
    
    .nb-toggle-btn {
      padding: 6px 12px;
      background: #0d6efd;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
    }
    
    .nb-toggle-btn:hover {
      background: #0b5ed7;
    }
  </style>

  <div style="margin-bottom: 10px;">
    <button class="nb-toggle-btn" onclick="window.toggleNeurobagelWidget()">
      ðŸ§  Open NeuroBagel Annotation Tool
    </button>
  </div>

  <div class="neurobagel-widget" id="neurobagelWidgetContent" style="display: none;">
    <!-- Sidebar -->
    <div class="nb-sidebar">
      <div class="nb-section-title">Standardized Variables</div>
      <div id="neurobagelSidebar"></div>
      
      <div class="nb-section-title" style="margin-top: 20px;">Unannotated</div>
      <div id="neurobagelUnannotated"></div>
    </div>
    
    <!-- Main Editor -->
    <div class="nb-main">
      <div id="neurobagelEditor">
        <div class="nb-empty-state">
          <p>Select a column from the sidebar to annotate</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// NeuroBagel Annotation Widget Functions
window.neurobagelWidgetState = {
  allColumns: {},
  selectedColumn: null,
  expanded: false
};

window.toggleNeurobagelWidget = function() {
  const widget = document.getElementById('neurobagelAnnotationWidget');
  const content = document.getElementById('neurobagelWidgetContent');
  const expanded = window.neurobagelWidgetState.expanded;
  
  window.neurobagelWidgetState.expanded = !expanded;
  content.style.display = expanded ? 'none' : 'flex';
};

// Auto-detect data type for custom columns based on TSV values
window.autoDetectDataType = function(colName, uniqueValues) {
  if (!uniqueValues || uniqueValues.length === 0) {
    return 'text';
  }
  
  // Rule 1: If <= 10 unique values, treat as categorical
  if (uniqueValues.length <= 10) {
    // Additional check: make sure they're not all numbers with different values
    const allNumeric = uniqueValues.every(v => !isNaN(v) && v !== '');
    if (allNumeric) {
      // If all numeric and > 5 unique values, could be continuous
      // But if they look like IDs or codes, keep as categorical
      const numericValues = uniqueValues.map(Number).sort((a, b) => a - b);
      const range = numericValues[numericValues.length - 1] - numericValues[0];
      const step = range > 0 ? range / (numericValues.length - 1) : 0;
      
      // If values are evenly spaced (like ages: 20, 21, 22...), likely continuous
      // If they're sparse or with gaps, likely codes/categories
      const isEvenlySpaced = numericValues.every((val, idx, arr) => {
        if (idx === 0) return true;
        const expectedDiff = step;
        const actualDiff = val - arr[idx - 1];
        return Math.abs(actualDiff - expectedDiff) < 1;
      });
      
      if (isEvenlySpaced && range > 5) {
        return 'continuous';
      }
    }
    
    return 'categorical';
  }
  
  // Rule 2: If > 10 unique values, likely continuous or text
  // Check if mostly numeric
  const numericCount = uniqueValues.filter(v => !isNaN(v) && v !== '').length;
  if (numericCount / uniqueValues.length > 0.8) {
    return 'continuous';
  }
  
  return 'text';
};

window.renderNeurobagelWidget = async function() {
  console.log('ðŸ§  renderNeurobagelWidget called');
  const data = await fetchNeurobagelParticipants();
  console.log('ðŸ§  Fetched data:', data);
  if (!data || !data.properties) {
    console.warn('âŒ No NeuroBagel data for widget');
    return;
  }
  console.log('âœ… Data has properties:', Object.keys(data.properties).length, 'columns');
  
  // Merge TSV unique values with NeuroBagel data for categorical columns
  const enrichedData = data.properties;
  if (window.participantsTsvData) {
    console.log('ðŸ”„ Merging TSV unique values with NeuroBagel data');
    for (const [colName, colData] of Object.entries(enrichedData)) {
      if (colData.data_type === 'categorical' && window.participantsTsvData[colName]) {
        const uniqueValues = window.participantsTsvData[colName];
        console.log(`ðŸ“Š Column ${colName} - TSV values:`, uniqueValues);
        
        // Create levels from TSV unique values ONLY (don't use defaults)
        colData.levels = {};
        
        // Add TSV values as levels
        uniqueValues.forEach(value => {
          colData.levels[value] = {
            label: value,
            description: '',  // User can add description later
            uri: null
          };
        });
        
        console.log(`âœ… Updated ${colName} with ${Object.keys(colData.levels).length} categorical levels from TSV`);
      }
    }
    
    // Auto-detect data types for custom columns in TSV (not in NeuroBagel)
    for (const [colName, uniqueValues] of Object.entries(window.participantsTsvData)) {
      if (!enrichedData[colName]) {
        // This is a custom column not in NeuroBagel
        const detectedType = window.autoDetectDataType(colName, uniqueValues);
        console.log(`ðŸ” Auto-detected data type for custom column ${colName}:`, detectedType);
        
        enrichedData[colName] = {
          description: `Column: ${colName}`,
          data_type: detectedType,
          standardized_variable: null
        };
        
        // If detected as categorical, add levels from TSV
        if (detectedType === 'categorical') {
          enrichedData[colName].levels = {};
          uniqueValues.forEach(value => {
            enrichedData[colName].levels[value] = {
              label: value,
              description: '',
              uri: null
            };
          });
          console.log(`ðŸ“Š Custom column ${colName} - added ${uniqueValues.length} categorical levels`);
        }
      }
    }
  } else {
    console.log('â„¹ï¸ No TSV data available - using NeuroBagel defaults only');
  }
  
  window.neurobagelWidgetState.allColumns = enrichedData;
  
  // Categorize columns into AVAILABLE (in TSV) and TO ADD (suggestions)
  const tsvColumns = window.participantsTsvData ? Object.keys(window.participantsTsvData) : [];
  const available = {};  // Columns in the TSV file
  const toAdd = {};      // NeuroBagel suggestions not in TSV
  
  for (const [colName, colData] of Object.entries(enrichedData)) {
    if (tsvColumns.includes(colName)) {
      available[colName] = colData;
    } else {
      toAdd[colName] = colData;
    }
  }
  
  console.log('ðŸ“Š Available columns (in TSV):', Object.keys(available));
  console.log('ðŸ“Š To Add (NeuroBagel suggestions):', Object.keys(toAdd));
  
  // Render sidebar
  const sidebar = document.getElementById('neurobagelSidebar');
  if (!sidebar) {
    console.error('âŒ neurobagelSidebar element not found!');
    return;
  }
  sidebar.innerHTML = '';
  
  // AVAILABLE section
  if (Object.keys(available).length > 0) {
    const availableSection = document.createElement('div');
    availableSection.style.marginBottom = '16px';
    
    const availableTitle = document.createElement('div');
    availableTitle.className = 'nb-section-title';
    availableTitle.style.marginTop = '0';
    availableTitle.textContent = 'âœ“ Available';
    availableSection.appendChild(availableTitle);
    
    for (const [colName, colData] of Object.entries(available)) {
      const item = document.createElement('div');
      item.className = 'nb-column-item';
      item.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
          <span>${colName}</span>
          <span class="nb-column-item-type">${colData.data_type}</span>
        </div>
      `;
      item.onclick = () => window.selectNeurobagelColumn(colName);
      availableSection.appendChild(item);
    }
    
    sidebar.appendChild(availableSection);
  }
  
  // TO ADD section
  if (Object.keys(toAdd).length > 0) {
    const toAddSection = document.createElement('div');
    
    const toAddTitle = document.createElement('div');
    toAddTitle.className = 'nb-section-title';
    toAddTitle.textContent = '+ To Add';
    toAddTitle.style.marginTop = Object.keys(available).length > 0 ? '12px' : '0';
    toAddSection.appendChild(toAddTitle);
    
    for (const [colName, colData] of Object.entries(toAdd)) {
      const item = document.createElement('div');
      item.className = 'nb-column-item';
      item.style.opacity = '0.7';
      item.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
          <span>${colName}</span>
          <span class="nb-column-item-type">${colData.data_type}</span>
        </div>
      `;
      item.onclick = () => window.selectNeurobagelColumn(colName);
      toAddSection.appendChild(item);
    }
    
    sidebar.appendChild(toAddSection);
  }
  
  // Force widget to be visible
  const widgetContent = document.getElementById('neurobagelWidgetContent');
  if (widgetContent) {
    widgetContent.style.display = 'flex';
    console.log('âœ… Widget content display set to flex');
  }
  
  console.log('âœ… renderNeurobagelWidget completed successfully');
};

window.selectNeurobagelColumn = function(colName) {
  window.neurobagelWidgetState.selectedColumn = colName;
  
  // Update active state
  document.querySelectorAll('.nb-column-item').forEach(item => {
    item.classList.remove('active');
  });
  event.target.closest('.nb-column-item').classList.add('active');
  
  // Render editor
  const colData = window.neurobagelWidgetState.allColumns[colName];
  window.renderNeurobagelEditor(colName, colData);
};

window.renderNeurobagelEditor = function(colName, colData) {
  const editor = document.getElementById('neurobagelEditor');
  const dataType = colData.data_type || 'unknown';
  
  let html = `
    <div class="nb-editor-header">
      <div>
        <div class="nb-editor-title">${colName}</div>
      </div>
      <div class="nb-editor-type-badge">${dataType}</div>
    </div>
    
    <!-- Editable Description Field -->
    <div class="nb-field-group">
      <label class="nb-field-label">Description</label>
      <textarea 
        class="nb-field-input" 
        id="nb-desc-${colName}" 
        placeholder="Enter description for this field"
        style="width: 100%; height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;"
      >${colData.description || ''}</textarea>
    </div>
  `;
  
  if (dataType === 'continuous') {
    // Editable unit field for continuous
    html += `
      <div class="nb-field-group">
        <label class="nb-field-label">Unit</label>
        <input 
          type="text" 
          class="nb-field-input" 
          id="nb-unit-${colName}" 
          placeholder="e.g., years, kg, mm"
          value="${colData.unit || ''}"
          style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;"
        />
      </div>
    `;
  } else if (dataType === 'categorical' && colData.levels) {
    // Categorical levels with editable descriptions
    html += `
      <div class="nb-field-group">
        <div class="nb-field-label">Categorical Levels</div>
        <div class="nb-value-list">
    `;
    
    for (const [levelKey, levelData] of Object.entries(colData.levels)) {
      const description = levelData.description || '';
      const uniqueId = `nb-cat-${colName}-${levelKey}`;
      
      html += `
        <div class="nb-categorical-item" style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin-bottom: 8px; background: #fff;">
          <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
            <span style="font-weight: 600; min-width: 60px; padding: 4px 8px; background: #e7f1ff; border-radius: 4px; font-size: 12px;">${levelKey}</span>
            <span style="color: #666; font-size: 12px;">â†’</span>
            <input 
              type="text" 
              class="nb-categorical-label" 
              id="${uniqueId}-label" 
              placeholder="Label (e.g., Healthy Controls)"
              value="${levelData.label || levelKey}"
              style="flex: 1; padding: 4px 8px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px;"
            />
          </div>
          <textarea 
            class="nb-categorical-desc" 
            id="${uniqueId}-desc" 
            placeholder="Description (e.g., Healthy control group)"
            style="width: 100%; height: 40px; padding: 6px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px;"
          >${description}</textarea>
          ${levelData.uri ? `<div style="margin-top: 6px; font-size: 11px; color: #666;">ðŸ”— <code>${levelData.uri}</code></div>` : ''}
        </div>
      `;
    }
    
    html += `
        </div>
      </div>
    `;
  }
  
  html += `
    <div class="nb-button-group">
      <button class="nb-btn nb-btn-primary" onclick="window.applyNeurobagelToForm('${colName}')">
        âœ“ Apply to Form
      </button>
      <button class="nb-btn" onclick="window.copyNeurobagelData('${colName}')">
        ðŸ“‹ Copy
      </button>
    </div>
  `;
  
  editor.innerHTML = html;
  
  // Store edited values back to column data when user changes them
  const descField = document.getElementById(`nb-desc-${colName}`);
  const unitField = document.getElementById(`nb-unit-${colName}`);
  
  if (descField) {
    descField.addEventListener('change', function() {
      colData.description = this.value;
      console.log(`Updated description for ${colName}:`, this.value);
    });
  }
  
  if (unitField) {
    unitField.addEventListener('change', function() {
      colData.unit = this.value;
      console.log(`Updated unit for ${colName}:`, this.value);
    });
  }
  
  // Add listeners for categorical level edits
  if (dataType === 'categorical' && colData.levels) {
    for (const levelKey of Object.keys(colData.levels)) {
      const uniqueId = `nb-cat-${colName}-${levelKey}`;
      const labelField = document.getElementById(`${uniqueId}-label`);
      const descField = document.getElementById(`${uniqueId}-desc`);
      
      if (labelField) {
        labelField.addEventListener('change', function() {
          colData.levels[levelKey].label = this.value || levelKey;
          console.log(`Updated label for ${colName}/${levelKey}:`, this.value);
        });
      }
      
      if (descField) {
        descField.addEventListener('change', function() {
          colData.levels[levelKey].description = this.value;
          console.log(`Updated description for ${colName}/${levelKey}:`, this.value);
        });
      }
    }
  }
};

window.applyNeurobagelLevel = function(colName, levelKey) {
  const colData = window.neurobagelWidgetState.allColumns[colName];
  const levelData = colData.levels[levelKey];
  
  // Find matching form fields and fill with level info
  const selector = `[data-json-path^="${colName}.levels.${levelKey}"]`;
  const matches = Array.from(document.querySelectorAll(selector));
  
  if (matches.length > 0) {
    const suggestion = `${levelData.label || levelKey}\nDescription: ${levelData.description}\nURI: ${levelData.uri || 'N/A'}`;
    matches.forEach(el => { el.value = suggestion; });
    if (typeof showAlert === 'function') {
      showAlert(`Applied ${colName}/${levelKey} level annotation`, 'success');
    }
  }
};

window.applyNeurobagelToForm = function(colName) {
  const colData = window.neurobagelWidgetState.allColumns[colName];
  
  // Find form fields for this column
  const selector = `[data-json-path^="${colName}."]`;
  const matches = Array.from(document.querySelectorAll(selector));
  
  if (matches.length === 0) {
    if (typeof showAlert === 'function') {
      showAlert(`No form fields found for ${colName}`, 'warning');
    }
    return;
  }
  
  // Build comprehensive annotation
  let annotation = `Column: ${colName}\n`;
  annotation += `Type: ${colData.data_type}\n`;
  annotation += `Standardized Variable: ${colData.standardized_variable || 'N/A'}\n`;
  annotation += `Description: ${colData.description || 'N/A'}\n`;
  
  if (colData.data_type === 'categorical' && colData.levels) {
    annotation += `\nCategorical Levels:\n`;
    for (const [k, v] of Object.entries(colData.levels)) {
      annotation += `  ${k}: ${v.label} (${v.uri || 'No URI'})\n`;
    }
  } else if (colData.data_type === 'continuous') {
    annotation += `Unit: ${colData.unit || 'Not specified'}\n`;
  }
  
  // Apply to first textarea
  if (matches.length > 0) {
    matches[0].value = annotation;
  }
  
  if (typeof showAlert === 'function') {
    showAlert(`Applied annotation to ${colName}`, 'success');
  }
};

window.copyNeurobagelData = function(colName) {
  const colData = window.neurobagelWidgetState.allColumns[colName];
  const json = JSON.stringify(colData, null, 2);
  
  navigator.clipboard.writeText(json).then(() => {
    if (typeof showAlert === 'function') {
      showAlert(`Copied ${colName} data to clipboard`, 'success');
    }
  });
};

// Initialize widget when NeuroBagel data loads
document.addEventListener('DOMContentLoaded', async function() {
  // Wait for NeuroBagel data to be available
  await new Promise(resolve => setTimeout(resolve, 1000));
  await window.renderNeurobagelWidget();
  document.getElementById('neurobagelAnnotationWidget').style.display = 'block';
});
</script>
