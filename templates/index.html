{% extends "base.html" %}

{% block title %}Psycho-Validator - Dataset Validation{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Header Section - simplified, consistent with navbar -->
        <div class="text-center mb-5">
            <h2 class="mb-3">
                <i class="fas fa-check-circle text-success me-2"></i>
                Dataset Validation
            </h2>
            <p class="lead text-muted">
                Validate your psychological dataset structure and metadata
            </p>
        </div>

        <!-- Main Upload Card -->
        <div class="card feature-card mb-4">
            <div class="card-body p-5">
                <h3 class="card-title text-center mb-4">
                    <i class="fas fa-upload text-primary me-2"></i>
                    Dataset Validation
                </h3>
                
                <!-- File Upload Section -->
                <div class="mb-4">
                    <h5 class="mb-3">
                        <i class="fas fa-upload me-2"></i>
                        Upload Dataset
                    </h5>
                    
                    <!-- Browser Support Warning -->
                    <div class="alert alert-info alert-dismissible fade show" role="alert" id="browserWarning" style="display: none;">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Folder upload requires a modern browser.</strong> 
                        If folder selection doesn't work, try using a ZIP file or the local folder path option below.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    
                    <!-- DataLad-Style Upload Notice -->
                    <div class="alert alert-success mb-3">
                        <i class="fas fa-lightning me-2"></i>
                        <strong>DataLad-Style Upload:</strong> Only structure and metadata (.json, .tsv, .csv, .txt) are uploaded. 
                        Large data files (.nii.gz, .mp4, images) are automatically skipped - placeholders are created for structure validation!
                        <br><small class="mt-1 d-block">
                            <i class="fas fa-info-circle me-1"></i>
                            This validates naming conventions, directory structure, and metadata completeness without transferring GB of data.
                        </small>
                    </div>
                    
                    <form action="{{ url_for('upload_dataset') }}" method="post" enctype="multipart/form-data">
                        <!-- Schema Version Selector -->
                        <div class="mb-3">
                            <label for="schema_version" class="form-label">
                                <i class="fas fa-code-branch me-2"></i>Schema Version
                            </label>
                            <select class="form-select" id="schema_version" name="schema_version">
                                {% for version in schema_versions %}
                                <option value="{{ version }}" {% if version == 'stable' %}selected{% endif %}>
                                    {{ version }}{% if version == 'stable' %} (default){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Select the schema version to use for validation. "stable" is recommended.
                            </small>
                        </div>

                        <!-- Strict Mode Checkbox -->
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="strict_mode" name="strict_mode" value="true">
                            <label class="form-check-label" for="strict_mode">
                                <strong>Strict Mode</strong> (Enforce PRISM compliance)
                            </label>
                            <div class="form-text">
                                If checked, BIDS-only files will be rejected. Uncheck to allow BIDS fallback (recommended for compatibility).
                            </div>
                        </div>
                        
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                            <h5>Select your dataset</h5>
                            <p class="text-muted">Choose a folder or ZIP file</p>
                            
                            <div class="btn-group mb-3" role="group">
                                <button type="button" class="btn btn-primary" id="folderBtn">
                                    <i class="fas fa-folder-open me-2"></i>Browse Folder
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="zipBtn">
                                    <i class="fas fa-file-archive me-2"></i>Browse ZIP File
                                </button>
                            </div>
                            
                            <!-- Hidden file inputs -->
                            <input type="file" class="d-none" id="datasetFolder" name="dataset" webkitdirectory directory multiple>
                            <input type="file" class="d-none" id="datasetZip" name="dataset" accept=".zip">
                        </div>
                        
                        <div class="mt-3 text-center">
                            <button type="submit" class="btn btn-success btn-lg" id="uploadBtn" disabled>
                                <i class="fas fa-check-circle me-2"></i>Validate Dataset
                            </button>
                        </div>
                        
                        <div class="mt-2 text-center">
                            <small class="text-muted" id="uploadInfo">
                                <i class="fas fa-info-circle me-1"></i>
                                Select a folder or ZIP file to start validation
                            </small>
                        </div>
                    </form>
                </div>

                <hr class="my-4">

                <!-- Local Folder Section -->
                <div class="mb-4">
                    <h5 class="mb-3">
                        <i class="fas fa-bolt me-2 text-success"></i>
                        Validate Local Folder (Best for Your Dataset!)
                    </h5>
                    <div class="alert alert-success border">
                        <div class="row align-items-center">
                            <div class="col-md-12">
                                <form action="{{ url_for('validate_folder') }}" method="post" class="mb-0">
                                    <!-- Schema Version Selector for Local Folder -->
                                    <div class="mb-3">
                                        <label for="folder_schema_version" class="form-label">
                                            <i class="fas fa-code-branch me-2"></i>Schema Version
                                        </label>
                                        <select class="form-select" id="folder_schema_version" name="schema_version">
                                            {% for version in schema_versions %}
                                            <option value="{{ version }}" {% if version == 'stable' %}selected{% endif %}>
                                                {{ version }}{% if version == 'stable' %} (default){% endif %}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <!-- Strict Mode Checkbox for Local Folder -->
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="folder_strict_mode" name="strict_mode" value="true">
                                        <label class="form-check-label" for="folder_strict_mode">
                                            <strong>Strict Mode</strong> (Enforce PRISM compliance)
                                        </label>
                                    </div>
                                    
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text">
                                            <i class="fas fa-folder-open"></i>
                                        </span>
                                        <input type="text" class="form-control" name="folder_path" 
                                               placeholder="Paste path here: /path/to/bids" 
                                               value=""
                                               required>
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-bolt me-2"></i>Validate Now
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <small class="text-success mt-2 d-block">
                            <i class="fas fa-check-circle me-1"></i>
                            <strong>✨ No upload needed!</strong> Works with datasets of any size - validates directly from your disk.
                        </small>
                            <strong>Tip:</strong> Copy the full path from your file manager. No upload needed - validates directly from your computer.
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Information Cards -->
        <div class="row mb-4">
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card feature-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-shield-alt fa-2x text-success mb-3"></i>
                        <h5>Privacy First</h5>
                        <p class="text-muted small">
                            Files are processed locally. Nothing is uploaded to external servers.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card feature-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-desktop fa-2x text-primary mb-3"></i>
                        <h5>Local Path (Fastest)</h5>
                        <p class="text-muted small">
                            Enter folder path directly - no upload needed. Works with any browser.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card feature-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-bar fa-2x text-info mb-3"></i>
                        <h5>Comprehensive Reports</h5>
                        <p class="text-muted small">
                            Detailed validation results with statistics and error categorization.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card feature-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-id-badge fa-2x text-warning mb-3"></i>
                        <h5>Lab Contact</h5>
                        <p class="text-muted small mb-1">
                            Karl Koschutnig · MRI-Lab Graz
                        </p>
                        <p class="text-muted small">
                            <a href="mailto:karl.koschutnig@uni-graz.at" class="text-decoration-none">karl.koschutnig@uni-graz.at</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Browser Compatibility Notice -->
        <div class="alert alert-info" role="alert">
            <h6 class="alert-heading">
                <i class="fas fa-browser me-2"></i>Browser Compatibility
            </h6>
            <p class="mb-2">
                <strong>Folder Upload:</strong> Requires Chrome 21+, Firefox 50+, Safari 11.1+, or Edge 79+
            </p>
            <p class="mb-0">
                <strong>Alternative:</strong> Use <em>Local Folder Path</em> (works with any browser) or ZIP file upload
            </p>
        </div>

        <!-- Dataset Structure Info -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-sitemap text-primary me-2"></i>
                    Expected Dataset Structure
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <pre class="bg-light p-3 rounded"><code>dataset/
├── dataset_description.json
├── participants.tsv (optional)
├── sub-01/
│   ├── ses-001/ (optional)
│   │   ├── image/
│   │   ├── movie/
│   │   └── audio/
│   └── behavior/
└── sub-02/
    └── ...</code></pre>
                    </div>
                    <div class="col-md-6">
                        <h6>Supported Modalities:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-image text-primary me-2"></i><code>image/</code> - Visual stimuli (.png, .jpg, .tiff)</li>
                            <li><i class="fas fa-video text-primary me-2"></i><code>movie/</code> - Video stimuli (.mp4, .avi, .mov)</li>
                            <li><i class="fas fa-volume-up text-primary me-2"></i><code>audio/</code> - Audio stimuli (.wav, .mp3, .flac)</li>
                            <li><i class="fas fa-brain text-primary me-2"></i><code>eeg/</code> - EEG recordings (.edf, .bdf)</li>
                            <li><i class="fas fa-eye text-primary me-2"></i><code>eyetracking/</code> - Eye tracking data</li>
                            <li><i class="fas fa-chart-line text-primary me-2"></i><code>behavior/</code> - Behavioral responses</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Version Info -->
        <div class="text-center text-muted">
            <small>
                <i class="fas fa-code-branch me-1"></i>
                Psycho-Validator version: <span class="badge bg-secondary">2.0.0</span>
            </small>
            <br>
            <small class="mt-2 d-block">
                <i class="fas fa-info-circle me-1"></i>
                Note: Dataset validation is performed locally. Files are never uploaded to external servers.
            </small>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// File upload handling
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const folderInput = document.getElementById('datasetFolder');
    const zipInput = document.getElementById('datasetZip');
    const folderBtn = document.getElementById('folderBtn');
    const zipBtn = document.getElementById('zipBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadInfo = document.getElementById('uploadInfo');
    const browserWarning = document.getElementById('browserWarning');

    // Check for webkitdirectory support
    const supportsFolderUpload = 'webkitdirectory' in document.createElement('input');
    
    if (!supportsFolderUpload) {
        browserWarning.style.display = 'block';
        folderBtn.disabled = true;
        folderBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Folder Upload Not Supported';
        folderBtn.classList.add('btn-warning');
        folderBtn.classList.remove('btn-primary');
    }

    // Folder button click
    folderBtn.addEventListener('click', function() {
        if (supportsFolderUpload) {
            folderInput.click();
        } else {
            alert('Folder upload is not supported in this browser. Please use the ZIP file option or try a modern browser like Chrome, Firefox, or Edge.');
        }
    });

    // ZIP button click
    zipBtn.addEventListener('click', function() {
        zipInput.click();
    });

    // Drag and drop handling
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            // Check if it's a ZIP file
            const firstFile = files[0];
            if (firstFile.name.toLowerCase().endsWith('.zip')) {
                zipInput.files = files;
                updateUploadButton('zip', firstFile);
            } else {
                // For folder drops, we need to simulate the file input
                if (supportsFolderUpload && files.length > 1) {
                    // Multiple files dropped - treat as folder
                    updateUploadButton('folder', null, files.length);
                } else {
                    uploadInfo.innerHTML = '<i class="fas fa-exclamation-triangle me-1 text-warning"></i>Please drop a ZIP file or use the browse buttons';
                }
            }
        }
    });

    // Folder selection handling
    folderInput.addEventListener('change', function() {
        if (folderInput.files.length > 0) {
            // Filter to metadata files only
            const metadataExtensions = ['.json', '.tsv', '.csv', '.txt', '.edf', '.bdf'];
            const skipExtensions = ['.nii', '.gz', '.mp4', '.avi', '.mov', '.png', '.jpg', '.jpeg', '.tiff', '.mat'];
            
            let metadataCount = 0;
            let skippedCount = 0;
            
            for (let file of folderInput.files) {
                const fileName = file.name.toLowerCase();
                const isSkipped = skipExtensions.some(ext => fileName.endsWith(ext));
                const isMetadata = metadataExtensions.some(ext => fileName.endsWith(ext));
                
                if (isMetadata) {
                    metadataCount++;
                } else if (isSkipped || fileName.endsWith('.nii.gz')) {
                    skippedCount++;
                }
            }
            
            updateUploadButton('folder', null, metadataCount, skippedCount);
        }
    });

    // ZIP file selection handling
    zipInput.addEventListener('change', function() {
        if (zipInput.files.length > 0) {
            updateUploadButton('zip', zipInput.files[0]);
        }
    });

    function updateUploadButton(type, file, fileCount, skippedCount) {
        uploadBtn.disabled = false;
        
        if (type === 'folder') {
            const actualFileCount = fileCount || folderInput.files.length;
            let folderName = 'Selected folder';
            
            if (folderInput.files.length > 0 && folderInput.files[0].webkitRelativePath) {
                folderName = folderInput.files[0].webkitRelativePath.split('/')[0];
            }
            
            uploadBtn.innerHTML = `<i class="fas fa-check-circle me-2"></i>Validate Folder "${folderName}"`;
            
            let infoText = `<i class="fas fa-folder me-1 text-success"></i>${actualFileCount} metadata files selected`;
            if (skippedCount > 0) {
                infoText += ` <span class="text-muted">(${skippedCount} data files will be skipped)</span>`;
            }
            uploadInfo.innerHTML = infoText;
            
            // Clear ZIP input
            zipInput.value = '';
            
            // Highlight folder button
            folderBtn.classList.add('btn-success');
            folderBtn.classList.remove('btn-primary');
            zipBtn.classList.add('btn-outline-primary');
            zipBtn.classList.remove('btn-success');
            
        } else if (type === 'zip') {
            uploadBtn.innerHTML = `<i class="fas fa-check-circle me-2"></i>Validate "${file.name}"`;
            uploadInfo.innerHTML = `<i class="fas fa-file-archive me-1 text-success"></i>ZIP file: ${file.name} (${(file.size / 1024 / 1024).toFixed(1)} MB)`;
            
            // Clear folder input
            folderInput.value = '';
            
            // Highlight ZIP button
            zipBtn.classList.add('btn-success');
            zipBtn.classList.remove('btn-outline-primary');
            folderBtn.classList.add('btn-primary');
            folderBtn.classList.remove('btn-success');
        }
    }

    // Show loading state on form submission
    document.querySelector('form[action*="upload"]').addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default submission
        
        // Validate that something is selected
        if (folderInput.files.length === 0 && zipInput.files.length === 0) {
            alert('Please select a folder or ZIP file before validating.');
            return false;
        }
        
        // Filter files to metadata only
        const metadataExtensions = ['.json', '.tsv', '.csv', '.txt', '.edf', '.bdf'];
        const skipExtensions = ['.nii', '.gz', '.mp4', '.avi', '.mov', '.png', '.jpg', '.jpeg', '.tiff', '.mat', '.eeg', '.dat', '.fif'];
        
    const form = e.target;
    const formData = new FormData();
        
    let includedCount = 0;
    let skippedCount = 0;
    let totalSize = 0;
    let allFilePaths = [];
    let metadataPaths = [];
        
        // Get the files to process
        const filesToProcess = folderInput.files.length > 0 ? folderInput.files : zipInput.files;
        
        // Filter and add only metadata files, but track all file paths
        for (let i = 0; i < filesToProcess.length; i++) {
            const file = filesToProcess[i];
            const fileName = file.name.toLowerCase();
            const filePath = file.webkitRelativePath || file.name;
            
            // Track all file paths
            allFilePaths.push(filePath);
            
            // Check if it's a metadata file
            const isMetadata = metadataExtensions.some(ext => fileName.endsWith(ext));
            const isSkipped = skipExtensions.some(ext => fileName.endsWith(ext)) || fileName.endsWith('.nii.gz');
            
            if (isMetadata && !isSkipped) {
                formData.append('dataset', file, filePath);
                metadataPaths.push(filePath);
                includedCount++;
                totalSize += file.size;
            } else if (isSkipped) {
                skippedCount++;
            }
        }
        
        // Send the complete file list so server can create structure
        formData.append('all_files', JSON.stringify(allFilePaths));
        metadataPaths.forEach(path => formData.append('metadata_paths[]', path));
        
        console.log(`Uploading ${includedCount} metadata files (${(totalSize/1024/1024).toFixed(2)} MB), skipping ${skippedCount} data files`);
        
        // Check if we have any files to upload
        if (includedCount === 0 && skippedCount === 0) {
            alert('No files found. Please ensure your dataset contains files.');
            return false;
        }
        
        // Show progress
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';
        uploadInfo.innerHTML = `<i class="fas fa-cog fa-spin me-1"></i>Uploading ${includedCount} metadata files, creating structure for ${skippedCount} data files...`;
        
        // Submit filtered data via fetch
        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                return response.text().then(text => {
                    throw new Error('Upload failed: ' + text);
                });
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Validate Dataset';
            uploadInfo.innerHTML = '<i class="fas fa-exclamation-triangle me-1 text-danger"></i>Upload failed: ' + error.message;
            alert('Upload failed: ' + error.message);
        });
        
        return false;
    });

    document.querySelector('form[action*="validate_folder"]').addEventListener('submit', function(e) {
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Validating...';
    });

    // Show browser compatibility info
    if (!supportsFolderUpload) {
        console.log('Browser does not support folder upload. webkitdirectory not available.');
    }
});
</script>
{% endblock %}