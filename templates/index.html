{% extends "base.html" %}

{% block title %}Psycho-Validator - Dataset Validation{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Header Section -->
        <div class="text-center mb-5">
            <h1 class="display-4 mb-3">
                <i class="fas fa-brain text-primary me-3"></i>
                Psycho-Validator
            </h1>
            <p class="lead text-muted">
                Select a <strong>psychological dataset folder</strong> to validate.
            </p>
            <p class="text-muted">
                A BIDS-inspired validation tool for psychological and psychophysical datasets
            </p>
            <p class="small text-success">
                <i class="fas fa-folder me-1"></i>
                <strong>New:</strong> Upload folders directly - no ZIP files needed!
            </p>
        </div>

        <!-- Main Upload Card -->
        <div class="card feature-card mb-4">
            <div class="card-body p-5">
                <h3 class="card-title text-center mb-4">
                    <i class="fas fa-upload text-primary me-2"></i>
                    Dataset Validation
                </h3>
                
                <!-- File Upload Section -->
                <div class="mb-4">
                    <h5 class="mb-3">
                        <i class="fas fa-upload me-2"></i>
                        Upload Dataset
                    </h5>
                    
                    <!-- Browser Support Warning -->
                    <div class="alert alert-info alert-dismissible fade show" role="alert" id="browserWarning" style="display: none;">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Folder upload requires a modern browser.</strong> 
                        If folder selection doesn't work, try using a ZIP file or the local folder path option below.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    
                    <form action="{{ url_for('upload_dataset') }}" method="post" enctype="multipart/form-data">
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                            <h5>Select your dataset</h5>
                            <p class="text-muted">Choose a folder or ZIP file</p>
                            
                            <div class="btn-group mb-3" role="group">
                                <button type="button" class="btn btn-primary" id="folderBtn">
                                    <i class="fas fa-folder-open me-2"></i>Browse Folder
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="zipBtn">
                                    <i class="fas fa-file-archive me-2"></i>Browse ZIP File
                                </button>
                            </div>
                            
                            <!-- Hidden file inputs -->
                            <input type="file" class="d-none" id="datasetFolder" name="dataset" webkitdirectory directory multiple>
                            <input type="file" class="d-none" id="datasetZip" name="dataset" accept=".zip">
                        </div>
                        
                        <div class="mt-3 text-center">
                            <button type="submit" class="btn btn-success btn-lg" id="uploadBtn" disabled>
                                <i class="fas fa-check-circle me-2"></i>Validate Dataset
                            </button>
                        </div>
                        
                        <div class="mt-2 text-center">
                            <small class="text-muted" id="uploadInfo">
                                <i class="fas fa-info-circle me-1"></i>
                                Select a folder or ZIP file to start validation
                            </small>
                        </div>
                    </form>
                </div>

                <hr class="my-4">

                <!-- Local Folder Section -->
                <div class="mb-4">
                    <h5 class="mb-3">
                        <i class="fas fa-desktop me-2"></i>
                        Validate Local Folder
                        <small class="text-muted">(Recommended for large datasets)</small>
                    </h5>
                    <div class="alert alert-light border">
                        <div class="row align-items-center">
                            <div class="col-md-9">
                                <form action="{{ url_for('validate_folder') }}" method="post" class="mb-0">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-folder-open"></i>
                                        </span>
                                        <input type="text" class="form-control" name="folder_path" 
                                               placeholder="Enter full path to dataset folder (e.g., /Users/username/Documents/my_dataset)" 
                                               required>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-search me-2"></i>Validate
                                        </button>
                                    </div>
                                </form>
                            </div>
                            <div class="col-md-3 text-end">
                                <small class="text-success">
                                    <i class="fas fa-bolt me-1"></i>
                                    <strong>Fastest option</strong>
                                </small>
                            </div>
                        </div>
                        <small class="text-muted mt-2 d-block">
                            <i class="fas fa-lightbulb me-1"></i>
                            <strong>Tip:</strong> Copy the full path from your file manager. No upload needed - validates directly from your computer.
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Information Cards -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card feature-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-shield-alt fa-2x text-success mb-3"></i>
                        <h5>Privacy First</h5>
                        <p class="text-muted small">
                            Files are processed locally. Nothing is uploaded to external servers.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card feature-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-desktop fa-2x text-primary mb-3"></i>
                        <h5>Local Path (Fastest)</h5>
                        <p class="text-muted small">
                            Enter folder path directly - no upload needed. Works with any browser.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card feature-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-bar fa-2x text-info mb-3"></i>
                        <h5>Comprehensive Reports</h5>
                        <p class="text-muted small">
                            Detailed validation results with statistics and error categorization.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Browser Compatibility Notice -->
        <div class="alert alert-info" role="alert">
            <h6 class="alert-heading">
                <i class="fas fa-browser me-2"></i>Browser Compatibility
            </h6>
            <p class="mb-2">
                <strong>Folder Upload:</strong> Requires Chrome 21+, Firefox 50+, Safari 11.1+, or Edge 79+
            </p>
            <p class="mb-0">
                <strong>Alternative:</strong> Use <em>Local Folder Path</em> (works with any browser) or ZIP file upload
            </p>
        </div>

        <!-- Dataset Structure Info -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-sitemap text-primary me-2"></i>
                    Expected Dataset Structure
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <pre class="bg-light p-3 rounded"><code>dataset/
├── dataset_description.json
├── participants.tsv (optional)
├── sub-01/
│   ├── ses-001/ (optional)
│   │   ├── image/
│   │   ├── movie/
│   │   └── audio/
│   └── behavior/
└── sub-02/
    └── ...</code></pre>
                    </div>
                    <div class="col-md-6">
                        <h6>Supported Modalities:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-image text-primary me-2"></i><code>image/</code> - Visual stimuli (.png, .jpg, .tiff)</li>
                            <li><i class="fas fa-video text-primary me-2"></i><code>movie/</code> - Video stimuli (.mp4, .avi, .mov)</li>
                            <li><i class="fas fa-volume-up text-primary me-2"></i><code>audio/</code> - Audio stimuli (.wav, .mp3, .flac)</li>
                            <li><i class="fas fa-brain text-primary me-2"></i><code>eeg/</code> - EEG recordings (.edf, .bdf)</li>
                            <li><i class="fas fa-eye text-primary me-2"></i><code>eyetracking/</code> - Eye tracking data</li>
                            <li><i class="fas fa-chart-line text-primary me-2"></i><code>behavior/</code> - Behavioral responses</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Version Info -->
        <div class="text-center text-muted">
            <small>
                <i class="fas fa-code-branch me-1"></i>
                Psycho-Validator version: <span class="badge bg-secondary">2.0.0</span>
            </small>
            <br>
            <small class="mt-2 d-block">
                <i class="fas fa-info-circle me-1"></i>
                Note: Dataset validation is performed locally. Files are never uploaded to external servers.
            </small>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// File upload handling
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const folderInput = document.getElementById('datasetFolder');
    const zipInput = document.getElementById('datasetZip');
    const folderBtn = document.getElementById('folderBtn');
    const zipBtn = document.getElementById('zipBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadInfo = document.getElementById('uploadInfo');
    const browserWarning = document.getElementById('browserWarning');

    // Check for webkitdirectory support
    const supportsFolderUpload = 'webkitdirectory' in document.createElement('input');
    
    if (!supportsFolderUpload) {
        browserWarning.style.display = 'block';
        folderBtn.disabled = true;
        folderBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Folder Upload Not Supported';
        folderBtn.classList.add('btn-warning');
        folderBtn.classList.remove('btn-primary');
    }

    // Folder button click
    folderBtn.addEventListener('click', function() {
        if (supportsFolderUpload) {
            folderInput.click();
        } else {
            alert('Folder upload is not supported in this browser. Please use the ZIP file option or try a modern browser like Chrome, Firefox, or Edge.');
        }
    });

    // ZIP button click
    zipBtn.addEventListener('click', function() {
        zipInput.click();
    });

    // Drag and drop handling
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            // Check if it's a ZIP file
            const firstFile = files[0];
            if (firstFile.name.toLowerCase().endsWith('.zip')) {
                zipInput.files = files;
                updateUploadButton('zip', firstFile);
            } else {
                // For folder drops, we need to simulate the file input
                if (supportsFolderUpload && files.length > 1) {
                    // Multiple files dropped - treat as folder
                    updateUploadButton('folder', null, files.length);
                } else {
                    uploadInfo.innerHTML = '<i class="fas fa-exclamation-triangle me-1 text-warning"></i>Please drop a ZIP file or use the browse buttons';
                }
            }
        }
    });

    // Folder selection handling
    folderInput.addEventListener('change', function() {
        if (folderInput.files.length > 0) {
            updateUploadButton('folder', null, folderInput.files.length);
        }
    });

    // ZIP file selection handling
    zipInput.addEventListener('change', function() {
        if (zipInput.files.length > 0) {
            updateUploadButton('zip', zipInput.files[0]);
        }
    });

    function updateUploadButton(type, file, fileCount) {
        uploadBtn.disabled = false;
        
        if (type === 'folder') {
            const actualFileCount = fileCount || folderInput.files.length;
            let folderName = 'Selected folder';
            
            if (folderInput.files.length > 0 && folderInput.files[0].webkitRelativePath) {
                folderName = folderInput.files[0].webkitRelativePath.split('/')[0];
            }
            
            uploadBtn.innerHTML = `<i class="fas fa-check-circle me-2"></i>Validate Folder "${folderName}"`;
            uploadInfo.innerHTML = `<i class="fas fa-folder me-1 text-success"></i>${actualFileCount} files selected from folder`;
            
            // Clear ZIP input
            zipInput.value = '';
            
            // Highlight folder button
            folderBtn.classList.add('btn-success');
            folderBtn.classList.remove('btn-primary');
            zipBtn.classList.add('btn-outline-primary');
            zipBtn.classList.remove('btn-success');
            
        } else if (type === 'zip') {
            uploadBtn.innerHTML = `<i class="fas fa-check-circle me-2"></i>Validate "${file.name}"`;
            uploadInfo.innerHTML = `<i class="fas fa-file-archive me-1 text-success"></i>ZIP file: ${file.name} (${(file.size / 1024 / 1024).toFixed(1)} MB)`;
            
            // Clear folder input
            folderInput.value = '';
            
            // Highlight ZIP button
            zipBtn.classList.add('btn-success');
            zipBtn.classList.remove('btn-outline-primary');
            folderBtn.classList.add('btn-primary');
            folderBtn.classList.remove('btn-success');
        }
    }

    // Show loading state on form submission
    document.querySelector('form[action*="upload"]').addEventListener('submit', function(e) {
        // Validate that something is selected
        if (folderInput.files.length === 0 && zipInput.files.length === 0) {
            e.preventDefault();
            alert('Please select a folder or ZIP file before validating.');
            return false;
        }
        
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        uploadInfo.innerHTML = '<i class="fas fa-cog fa-spin me-1"></i>Uploading and validating dataset...';
        
        // Show progress message
        const progressDiv = document.createElement('div');
        progressDiv.className = 'alert alert-info mt-3';
        progressDiv.innerHTML = '<i class="fas fa-clock me-2"></i>This may take a few moments for large datasets...';
        uploadBtn.parentElement.appendChild(progressDiv);
    });

    document.querySelector('form[action*="validate_folder"]').addEventListener('submit', function(e) {
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Validating...';
    });

    // Show browser compatibility info
    if (!supportsFolderUpload) {
        console.log('Browser does not support folder upload. webkitdirectory not available.');
    }
});
</script>
{% endblock %}